---
layout:     post
title:     HTTPS抓包的两种方式
subtitle:   如何解开HTTPS明文
date:       2025-03-30
author:     mengxun
header-img: img/bg/gray-raw.png
catalog: true
tags:
    - 网络
---


#### 0x01 前言

`HTTPS` 的通信过程主要由非对称加密的握手阶段以及对称加密的通信阶段组成，而有时我们排查问题，需要看到原始明文才可以，那么这个加密报文就会对我们造成困扰，此时就需要借助一定手段去将加密报文解开成原始明文。

这里介绍两种常用的 `HTTPS` 抓包工具，来帮助我们实现查看原始明文的目的
- `mitmproxy`
- `Wireshark`


#### 0x02 mitmproxy

首先，去[官网](https://www.mitmproxy.org/downloads/)根据自己系统的版本下载较新的安装包，我这里过程以 `Windows` 为例介绍下安装过程，其他系统的过程也基本类似。

- 比如我下载的是 `mitmproxy-11.1.3-windows-x86_64-installer.exe`，下载后便可进行安装，安装完成后 `win+R` 输入 `cmd`，然后执行 `mitmweb` 命令，即可启动带web界面的 `mitmproxy`（ web界面默认在 http://127.0.0.1:8081/ ）

![image.png](https://s2.loli.net/2025/12/04/3gVbQmp8DjPnRAz.png)

- `mitmproxy` 启动后，还需要设置系统代理，这样浏览器的流量便会发往 `mitmproxy`（ 此处的默认监听端口是8080 ）
  ![image.png](https://s2.loli.net/2025/12/04/DsePwyKR5tNl2xm.png)

- 再之后就是最关键的一步了：安装证书。点击 安装 的菜单后，会出现证书的列表让你选择，可根据自己系统进行相应下载，下载后直接点击证书文件便可进行安装，安装过程有两处细节需要注意：1. 密码无需填写  2. 证书存储到受信任的根证书里，至此就算安装完成了。
  ![image.png](https://s2.loli.net/2025/12/04/Lyfqb7SntRVi2gM.png)


![image.png](https://s2.loli.net/2025/12/04/7k65pXG1bZ8OoYC.png)
![image.png](https://s2.loli.net/2025/12/04/UrCuRzacM971X4D.png)





证书安装完毕后，就可以正常抓取 `HTTPS` 流量了，比如我这里登陆 `https://www.douban.com/`，`mitmproxy` 的页面上就会自动刷出豆瓣相关的流量（这里可使用搜索条件：比如 `douban ~m POST` 代表搜索 `url包含douban且请求方式为POST` 的请求）
![image.png](https://s2.loli.net/2025/12/04/EnXraV8ACLWRPGs.png)



点击相应请求便可以在右侧看到原始明文了



![image.png](https://s2.loli.net/2025/12/04/LETkG6RjVYdPgue.png)



请求/响应 的 header 和 body 都一览无余，比如这里的账户密码信息都是可以看到的



```
remember:  true
name:      123456@qq.com
password:  test123
ticket:    tr03M0vG3hCGDIKOaSGZa5ZSbXcmBx68OrYtfVEIgqd7EiD_bz6JXzLShQMqYCrWhgMWAZ4tp11HgqLwD2gxvhuOWTsxvBZx_siF9ncCTuNqQQ4gjXaq_vxcwoUvZG29bLmw
randstr:   @IrS
tc_app_id: 2044348370
```



另外，此时我们点击豆瓣官网的证书信息，可以看到如下内容



```
颁发者
    公用名(CN)	mitmproxy
    组织(O)	mitmproxy
    组织单位(OU)	<不是证书的一部分>
```


我们平常判断 `HTTPS`流量 是不是被劫持了，其实就可以通过查看证书信息的方式来确定，不过最根本的还是不要往系统的根证书里乱安装证书。



#### 0x03 Wireshark

使用 `Wireshark` 解密出原始明文，主要依赖浏览器一个不成文的机制，就是当环境变量里存在 `SSLKEYLOGFILE` 这个key时，浏览器会将 `HTTPS` 用于加解密的关键信息（比如 随机数、密钥 等）导出一份副本到这个key设置的文件里。

而 `Wireshark` 也明确在 [文档](https://wiki.wireshark.org/TLS#tls-decryption) 里支持从这个环境变量里读取关键信息。这样的话，`Wireshark` 自然就可以利用这些关键信息对报文进行解密。

在`Windows`的场景下，具体操作如下：
- 首先设置环境变量（注意路径里一定不能存在中文，否则浏览器不会写入文件）
![image.png](https://s2.loli.net/2025/12/05/PkECTO19W6aAsxw.png)


- 在 Wireshark 的 Edit -> Preferences -> Protocols -> TLS 里配置日志文件名（和环境变量里配置的保持一致）
![image.png](https://s2.loli.net/2025/12/05/Mk6vdbITe8HVCiy.png)



完成这两步操作之后，再重启浏览器并且开启抓包，就可以顺利抓取到明文了

![image.png](https://s2.loli.net/2025/12/05/369IjHyiwEuvM2T.png)


#### 0x04 小结

最后比较下这两种方式之间的差异：

- `mitmproxy` 的方式直接走的系统代理，适用范围比较广；而 `Wireshark` 则依赖客户端写入关键信息，一旦客户端不支持就无法使用该方式，适用范围相对较窄。

- `mitmproxy` 本质上是在扮演一个中间人代理，整个过程里会存在两段连接；而 `WireShark` 只是利用获取到的密钥信息，对报文进行解密而已，整个过程里还是只有一段连接，流量并不会被代理。