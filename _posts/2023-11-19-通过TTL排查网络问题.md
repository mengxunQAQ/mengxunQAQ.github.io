---
layout:     post
title:     通过TTL排查网络问题
subtitle:   如何判断包来源
date:       2023-11-19
author:     mengxun
header-img: img/bg/gray-raw.png
catalog: true
tags:
    - 随笔
---





#### 0x01 背景

最近有一台客户那里的设备连接公司云端服务的时候一直无法正常连接，通过工程线找到了研发这里，于是在客户环境那里进行了排查，排查过程比较有趣，在此记录一下



#### 0x02 过程

上了客户环境第一步就是通过 tcpdump 对通信过程进行抓包，发现是设备在 tcp握手 之后，尝试给云端发消息的时候，云端直接返了RST，收到对端的RST之后设备连接自然就关闭了。但随后是找了本地的其他一些设备连接云端，发现通信都是没问题的，而且作为云端也不太可能单单针对客户这一台设备特殊处理 专拣这一台设备断连，事情确实比较反常，于是把 tcpdump 抓的包保存到文件里传送过来细看



但是看了一番之后没发现什么头绪。。设备发出去的包都挺正常的，但是对端就是一直给RST强行断连接



于是只能上对比大法了，在本地设备上也抓了相同通信过程的包，然后对比3层4层的各个字段，发现了一个重大问题：客户现场的RST包的TTL完全没有任何衰减，而本地设备收到正常回包里的TTL是要减去一定数量的。TTL每过一个路由都是要减去1的（比如 traceroute 的原理就是发TTL大小不等的包，期待可以收到路由器的 icmp差错报文），但是客户这里完全不衰减，说明这个包肯定不是从云端来的，是从客户内网发出的，于是让客户帮忙在出口路由也进行抓包，发现出口路由也有RST包，只是这个RST是发给云端的，相当于设备和云端同时都被发了RST包，但设备和云端其实都没有往外发过RST，也就说明中间有地方在冒充客户端和服务端两头骗



#### 0x03 结论

经过客户对网络拓扑的排查，发现中间存在上网行为管理设备，而设备和云端连接是要通过ssh隧道的，ssh的内容被上网行为管理判定为非法连接就强行断连了，在上网行为管理设备上进行放通后，连接便恢复了正常







